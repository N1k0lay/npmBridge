# Оптимизация хранения версий пакетов

## Обзор

Система оптимизации хранения и переноса версий npm-пакетов, которая минимизирует занимаемое место и обеспечивает актуальность версий при переносе в изолированные сети.

## Проблема

При хранении пакетов накапливается много устаревших патч-версий:

```
@rollup/plugin-node-resolve:
  15.2.3, 15.3.0, 15.3.1, 16.0.0, 16.0.1, 16.0.3
```

Из этих 6 версий реально нужны только 3:
- `15.2.3` — последняя в линейке `15.2.x`
- `15.3.1` — последняя в линейке `15.3.x`
- `16.0.3` — последняя в линейке `16.0.x`

## Ключевые принципы

### 1. Хранение "на лету" без дополнительных структур

Используем `package.json` из Verdaccio storage как единственный источник истины о скачанных версиях.

### 2. Хранение по потребности

- Если версия `4.x.x` никогда не запрашивалась — её нет в storage
- Если запрашивалась — значит нужна как зависимость
- Глубина мажорных линеек определяется реальным использованием

### 3. Последний патч в каждой минорной линейке

Для каждой комбинации `MAJOR.MINOR` храним только последнюю патч-версию.

### 4. Без prerelease версий

Версии типа `16.0.0-alpha.1`, `16.0.0-beta.2`, `16.0.0-rc.1` не хранятся и не переносятся.

---

## Алгоритм оптимизации

### Шаг 1: Обновление package.json через Verdaccio

```bash
# Установка latest версии пакета обновляет package.json в storage
npm install <package>@latest --registry=http://verdaccio:4873
```

Verdaccio автоматически обновит `storage/<package>/package.json` актуальными метаданными.

### Шаг 2: Чтение локального состояния

```
Читаем: storage/<package>/package.json
Получаем: список всех скачанных версий из поля "versions"
```

### Шаг 3: Фильтрация prerelease

```python
# Отфильтровываем prerelease версии
valid_versions = [v for v in versions if '-' not in v]
```

### Шаг 4: Группировка по MAJOR.MINOR

```
Вход: ['15.2.1', '15.2.3', '15.3.0', '15.3.1', '16.0.0', '16.0.1', '16.0.3']

Группы:
  15.2.x: [15.2.1, 15.2.3]
  15.3.x: [15.3.0, 15.3.1]
  16.0.x: [16.0.0, 16.0.1, 16.0.3]
```

### Шаг 5: Проверка актуальности через npm registry

```
Запрос: https://registry.npmjs.org/<package>
Получаем: актуальный package.json с последними версиями
```

Для каждой группы `MAJOR.MINOR`:
- Определяем последний патч в публичном registry
- Сравниваем с тем, что есть локально

### Шаг 6: Определение действий

| Ситуация | Действие |
|----------|----------|
| Локально `15.3.1`, в registry `15.3.1` | Оставить, можно переносить |
| Локально `15.3.1`, в registry `15.3.2` | Сначала sync `15.3.2`, потом переносить |
| Локально `15.3.0` и `15.3.1` | Удалить `15.3.0`, оставить `15.3.1` |
| Версия `16.0.0-rc.1` | Удалить (prerelease) |

### Шаг 7: Очистка

1. Удалить tarball-файлы ненужных версий
2. Обновить локальный `package.json` (убрать удалённые версии)

---

## Логика переноса в сети

### Сценарий: накопились обновления

**Накопилось для переноса:** `16.0.1, 16.0.2, 16.0.3, 15.3.0, 15.3.1`

**Результат оптимизации:**
- `16.0.3` — переносим (последняя в `16.0.x`)
- `15.3.1` — проверяем registry...
  - Если `15.3.1` последняя → переносим
  - Если есть `15.3.2` → ждём sync, не переносим `15.3.1`

### Алгоритм переноса

```
1. Обновить package.json (npm install <pkg>@latest)
2. Читаем локальный package.json
3. Запрашиваем npm registry package.json
4. Для каждой MAJOR.MINOR линейки:
   a. Находим последний патч в registry
   b. Если он у нас есть → добавляем в список переноса
   c. Если нет → сначала sync, потом transfer
5. Фильтруем prerelease версии
6. Переносим только отфильтрованный список
```

---

## Хранение по потребности

### Как это работает

1. Мы НЕ качаем версии проактивно
2. Качаем только то, что запрашивается при `npm install`
3. Если `4.x.x` запросили → нужна → храним и оптимизируем
4. Если `4.x.x` никто не запрашивал → её нет в storage

### Пример

Пользователь ставит пакет с зависимостью на `lodash@^4.17.0`:
- Verdaccio скачивает `lodash@4.17.21` (latest в `4.17.x`)
- Эта версия попадает в storage
- При оптимизации мы её сохраняем

Позже выходит `lodash@4.17.22`:
- При следующем `npm install` Verdaccio обновит package.json
- Мы увидим, что появилась новая версия
- Sync `4.17.22`, удаляем `4.17.21`

---

## Структура данных

### Локальный package.json (Verdaccio storage)

```
storage/
  @rollup/
    plugin-node-resolve/
      package.json          # Метаданные всех версий
      plugin-node-resolve-15.2.3.tgz
      plugin-node-resolve-15.3.1.tgz
      plugin-node-resolve-16.0.3.tgz
```

### Поля package.json

```json
{
  "name": "@rollup/plugin-node-resolve",
  "versions": {
    "15.2.3": { ... },
    "15.3.1": { ... },
    "16.0.3": { ... }
  },
  "dist-tags": {
    "latest": "16.0.3"
  }
}
```

---

## Режимы работы

### Агрессивная оптимизация (рекомендуется)

- Удаляем старые патчи из storage
- Если у кого-то `package-lock.json` на старую версию → пересоздаст lock-файл
- **Плюс:** Минимум хранения
- **Минус:** Редкие случаи пересоздания lock-файла

### Консервативный режим

- Храним все скачанные версии
- Переносим в сети только последние патчи
- **Плюс:** Ничего не ломается локально
- **Минус:** Локальное хранилище растёт

---

## Периодическая проверка старых линеек

### Зачем

Для `15.x.x` могут выходить security-патчи, даже когда актуальная версия `16.x.x`.

### Как

1. По расписанию запрашиваем `package.json` для отслеживаемых пакетов
2. Проверяем — появились ли новые версии в старых мажорных линейках
3. Если да — добавляем в очередь на sync

---

## API / Команды

### Оптимизация одного пакета

```bash
python scripts/optimize_versions.py <package-name>
```

### Оптимизация всех пакетов

```bash
python scripts/optimize_versions.py --all
```

### Dry-run (показать что будет удалено)

```bash
python scripts/optimize_versions.py <package-name> --dry-run
```

### Интеграция с существующими скриптами

Вызывать оптимизацию:
- После `update_single.py`
- После `update_recent.py`
- Перед `create_diff.py`

---

## Пример работы

### Входные данные

```
Локальный storage: 15.2.3, 15.3.0, 15.3.1, 16.0.0, 16.0.1, 16.0.3
npm registry:      15.2.3, 15.3.2, 16.0.3  (последние в своих линейках)
```

### Результат оптимизации

```
Оставить:   15.2.3, 16.0.3
Удалить:    15.3.0, 15.3.1, 16.0.0, 16.0.1
Sync:       15.3.2 (новая версия в линейке 15.3.x)

После sync:
Хранится:   15.2.3, 15.3.2, 16.0.3
Переносим:  15.2.3, 15.3.2, 16.0.3
```

---

## Открытые вопросы

1. **Как часто проверять актуальность?**
   - При каждом transfer?
   - По расписанию (cron)?
   - Вручную?

2. **Нужен ли dry-run режим по умолчанию?**
   - Сначала показать, потом применить?

3. **Логирование удалений?**
   - Писать в лог что удалено для аудита?

4. **Откат?**
   - Если что-то удалили ошибочно — можно заново скачать из npm

---

## Связанные файлы

- `scripts/update_single.py` — обновление одного пакета
- `scripts/create_diff.py` — создание diff для переноса
- `verdaccio/conf/config.yaml` — конфигурация Verdaccio
